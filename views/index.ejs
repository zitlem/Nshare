<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Server<% if (current_path) { %> - <%= current_path %><% } %></title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/css/fontawesome.min.css">
    
    <!-- Highlight.js for code syntax -->
    <link rel="stylesheet" href="/css/highlight-default.min.css">
    
    <!-- Socket.IO -->
    <script src="/js/socket.io.min.js"></script>
    
    <!-- Enhanced Preview Libraries -->
    <script src="/js/pdf.min.js"></script>
    <script src="/js/highlight.min.js"></script>
    <script src="/js/marked.min.js"></script>
    
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --hover-color: #e9ecef;
            --accent-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        
        [data-theme="dark"] {
            --bg-primary: #212529;
            --bg-secondary: #343a40;
            --bg-tertiary: #495057;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --hover-color: #495057;
            --shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(-45deg, #e9ecef, #dee2e6, #ced4da, #adb5bd);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            line-height: 1.5;
            transition: color 0.3s;
            min-height: 100vh;
        }
        
        [data-theme="dark"] body {
            background: linear-gradient(-45deg, #0d1117, #0c1419, #0a0e1a, #1c1f26);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        
        .btn {
            background: rgba(13, 110, 253, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            transition: all 0.2s;
            font-size: 0.8125rem;
            white-space: nowrap;
            min-height: 2rem;
            box-sizing: border-box;
        }
        
        .btn:hover {
            background: rgba(13, 110, 253, 0.9);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-secondary {
            background: rgba(233, 236, 239, 0.7);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
            border: 1px solid rgba(222, 226, 230, 0.3);
        }
        
        [data-theme="dark"] .btn-secondary {
            background: rgba(73, 80, 87, 0.7);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        
        .btn-danger {
            background: var(--danger-color);
        }
        
        .btn-success {
            background: rgba(25, 135, 84, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .theme-toggle {
            background: rgba(248, 249, 250, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(222, 226, 230, 0.2);
            color: var(--text-primary);
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 2rem;
            box-sizing: border-box;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .theme-toggle {
            background: rgba(52, 58, 64, 0.3);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .theme-toggle:hover {
            background: rgba(248, 249, 250, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="dark"] .theme-toggle:hover {
            background: rgba(52, 58, 64, 0.5);
        }
        
        .main-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .breadcrumb-toolbar {
            margin-bottom: 0.75rem;
            padding: 0.5rem 0.75rem;
            background: rgba(248, 249, 250, 0.4);
            backdrop-filter: blur(20px);
            border-radius: 0.375rem;
            border: 1px solid rgba(222, 226, 230, 0.15);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        [data-theme="dark"] .breadcrumb-toolbar {
            background: rgba(52, 58, 64, 0.4);
            border: 1px solid rgba(73, 80, 87, 0.15);
        }
        
        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .action-buttons {
            display: flex;
            align-items: stretch;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .breadcrumb a {
            color: var(--accent-color);
            text-decoration: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .breadcrumb a:hover {
            background: rgba(233, 236, 239, 0.3);
            backdrop-filter: blur(5px);
        }
        
        [data-theme="dark"] .breadcrumb a:hover {
            background: rgba(73, 80, 87, 0.3);
        }
        
        .breadcrumb .separator {
            margin: 0 0.5rem;
            color: var(--text-secondary);
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .sort-controls select {
            background: rgba(248, 249, 250, 0.3);
            backdrop-filter: blur(15px);
            color: var(--text-primary);
            border: 1px solid rgba(222, 226, 230, 0.2);
            border-radius: 0.375rem;
            padding: 0.375rem 0.5rem;
            min-height: 2rem;
            box-sizing: border-box;
        }
        
        [data-theme="dark"] .sort-controls select {
            background: rgba(52, 58, 64, 0.3);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .file-list {
            background: rgba(248, 249, 250, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(222, 226, 230, 0.15);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        [data-theme="dark"] .file-list {
            background: rgba(52, 58, 64, 0.4);
            border: 1px solid rgba(73, 80, 87, 0.15);
        }
        
        .file-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            align-items: start;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            gap: 0.75rem;
            min-height: auto;
        }
        
        .file-item:hover {
            background: rgba(233, 236, 239, 0.3);
            backdrop-filter: blur(10px);
        }
        
        [data-theme="dark"] .file-item:hover {
            background: rgba(73, 80, 87, 0.3);
        }
        
        
        .file-icon {
            font-size: 1.5rem;
            width: 2rem;
            text-align: center;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 0.1rem;
        }
        
        .file-icon.folder {
            color: #ffc107;
        }
        
        .file-icon.image {
            color: #28a745;
        }
        
        .file-icon.video {
            color: #dc3545;
        }
        
        .file-icon.audio {
            color: #6f42c1;
        }
        
        .file-icon.document {
            color: #007bff;
        }
        
        .file-info {
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            word-break: break-word;
            margin-bottom: 0.25rem;
            line-height: 1.4;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .file-meta {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .file-size, .file-date, .file-actions {
            color: var(--text-secondary);
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        .file-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .file-item:hover .file-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: rgba(233, 236, 239, 0.4);
            backdrop-filter: blur(8px);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .action-btn:hover {
            background: rgba(73, 80, 87, 0.4);
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(222, 226, 230, 0.2);
            border-radius: 0.375rem;
            padding: 0.5rem;
            min-width: 200px;
        }
        
        [data-theme="dark"] .search-box {
            background: rgba(33, 37, 41, 0.3);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .search-box input {
            border: none;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            color: var(--text-primary);
            outline: none;
            flex: 1;
            margin-left: 0.5rem;
            margin-right: 0.25rem;
        }
        
        [data-theme="dark"] .search-box input {
            background: rgba(33, 37, 41, 0.2);
        }
        
        .search-clear-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 1.5rem;
            height: 1.5rem;
            transition: all 0.2s;
            font-size: 0.75rem;
        }
        
        .search-clear-btn:hover {
            background: rgba(108, 117, 125, 0.2);
            color: var(--text-primary);
        }
        
        body.dragover::before {
            content: "Drop files anywhere to upload";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 110, 253, 0.9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            z-index: 10000;
            pointer-events: none;
        }
        
        .context-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            display: none;
        }
        
        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .context-menu-item:last-child {
            border-bottom: none;
        }
        
        .context-menu-item:hover {
            background: rgba(233, 236, 239, 0.4);
            backdrop-filter: blur(8px);
        }
        
        [data-theme="dark"] .context-menu-item:hover {
            background: rgba(73, 80, 87, 0.4);
        }
        
        .context-menu-item.danger:hover {
            background: var(--danger-color);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            width: 500px;
            border: 1px solid rgba(222, 226, 230, 0.2);
        }
        
        [data-theme="dark"] .modal-content {
            background: rgba(33, 37, 41, 0.8);
            border: 1px solid rgba(73, 80, 87, 0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(222, 226, 230, 0.3);
            border-radius: 0.375rem;
            background: rgba(248, 249, 250, 0.6);
            backdrop-filter: blur(10px);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .form-control {
            background: rgba(52, 58, 64, 0.6);
            border: 1px solid rgba(73, 80, 87, 0.3);
        }
        
        .progress-container {
            margin-top: 1rem;
            display: none;
        }
        
        .progress-bar {
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            height: 1rem;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--accent-color);
            height: 100%;
            width: 0%;
            transition: width 0.3s;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .download-queue {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            max-width: 300px;
            box-shadow: var(--shadow);
            display: none;
        }
        
        .download-queue.show {
            display: block;
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .queue-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .queue-item:last-child {
            border-bottom: none;
        }
        
        .shared-text-area {
            background: rgba(248, 249, 250, 0.25);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(222, 226, 230, 0.1);
            border-radius: 0.5rem;
            margin-top: 1rem;
            overflow: hidden;
        }
        
        [data-theme="dark"] .shared-text-area {
            background: rgba(52, 58, 64, 0.25);
            border: 1px solid rgba(73, 80, 87, 0.1);
        }
        
        .shared-text-header {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(222, 226, 230, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 249, 250, 0.1);
            backdrop-filter: blur(5px);
        }
        
        [data-theme="dark"] .shared-text-header {
            border-bottom: 1px solid rgba(73, 80, 87, 0.2);
            background: rgba(52, 58, 64, 0.1);
        }
        
        .shared-text-content {
            height: 180px;
            resize: none;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            color: var(--text-primary);
            padding: 0.5rem;
            width: 100%;
            font-family: inherit;
        }
        
        [data-theme="dark"] .shared-text-content {
            background: rgba(33, 37, 41, 0.15);
        }
        
        .text-formatting {
            padding: 0.375rem 0.75rem;
            display: flex;
            gap: 0.375rem;
            flex-wrap: wrap;
        }
        
        .format-btn {
            background: rgba(233, 236, 239, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(222, 226, 230, 0.3);
            color: var(--text-primary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        [data-theme="dark"] .format-btn {
            background: rgba(73, 80, 87, 0.5);
            border: 1px solid rgba(108, 117, 125, 0.3);
        }
        
        .format-btn:hover {
            background: rgba(233, 236, 239, 0.7);
            transform: translateY(-1px);
        }
        
        [data-theme="dark"] .format-btn:hover {
            background: rgba(73, 80, 87, 0.7);
        }
        
        #alertContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 400px;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .alert-success {
            background: rgba(25, 135, 84, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        
        .alert-info {
            background: rgba(13, 110, 253, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        .loading-spinner {
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .main-content {
                padding: 0.5rem;
            }
            
            .breadcrumb-toolbar {
                padding: 0.5rem;
                border-radius: 0.25rem;
            }
            
            .toolbar-row {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .breadcrumb {
                font-size: 0.875rem;
                flex-wrap: wrap;
            }
            
            .breadcrumb a {
                padding: 0.375rem 0.5rem;
            }
            
            .action-buttons {
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .action-buttons .btn,
            .action-buttons .theme-toggle {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                min-height: 2.5rem;
                flex: 1;
                min-width: 100px;
            }
            
            .sort-controls {
                justify-content: center;
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .sort-controls select {
                min-height: 2.5rem;
                font-size: 0.875rem;
                padding: 0.5rem;
                flex: 1;
                min-width: 120px;
            }
            
            .search-box {
                min-width: auto;
                flex: 1;
                padding: 0.75rem;
                font-size: 1rem;
                min-height: 3rem;
            }
            
            .search-box input {
                font-size: 1rem;
                padding: 0.5rem;
            }
            
            /* Mobile File List */
            .file-item {
                grid-template-columns: auto 1fr auto;
                gap: 0.5rem;
                padding: 0.5rem 0.75rem;
                min-height: 3rem;
                cursor: pointer;
                position: relative;
                align-items: center;
            }
            
            .file-item:active {
                background: rgba(13, 110, 253, 0.1);
                transform: scale(0.98);
                transition: all 0.1s;
            }
            
            .file-icon {
                font-size: 1.5rem;
                width: 2rem;
            }
            
            .file-name {
                font-size: 0.95rem;
                font-weight: 500;
                line-height: 1.3;
            }
            
            .file-size, .file-date {
                display: none;
            }
            
            .file-actions {
                opacity: 1;
                flex-direction: row;
                gap: 0.25rem;
            }
            
            .action-btn {
                padding: 0.375rem;
                border-radius: 0.25rem;
                font-size: 0.875rem;
                min-width: 2rem;
                min-height: 2rem;
            }
            
            /* Mobile Modals */
            .modal-content {
                width: 95vw;
                height: 90vh;
                padding: 1rem;
                margin: 0;
                border-radius: 0.5rem;
                overflow: auto;
            }
            
            .modal-header {
                margin-bottom: 1rem;
                position: sticky;
                top: 0;
                background: inherit;
                z-index: 10;
                border-bottom: 1px solid var(--border-color);
                padding-bottom: 0.5rem;
            }
            
            /* Mobile Context Menu */
            .context-menu {
                width: 90vw;
                max-width: 300px;
                left: 50% !important;
                transform: translateX(-50%);
                bottom: 2rem !important;
                top: auto !important;
                border-radius: 1rem;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            }
            
            .context-menu-item {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                min-height: 3rem;
                display: flex;
                align-items: center;
                border-radius: 0;
            }
            
            .context-menu-item:first-child {
                border-radius: 1rem 1rem 0 0;
            }
            
            .context-menu-item:last-child {
                border-radius: 0 0 1rem 1rem;
            }
            
            /* Mobile Shared Text */
            .shared-text-content {
                height: 200px;
                font-size: 1rem;
                line-height: 1.5;
            }
            
            .text-formatting {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .format-btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
                min-height: 2.5rem;
            }
            
            /* Mobile Upload Progress */
            .progress-container {
                margin: 1rem 0;
            }
            
            .progress-bar {
                height: 1.5rem;
                border-radius: 1rem;
            }
            
            .progress-text {
                font-size: 1rem;
                margin-top: 0.75rem;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 480px) {
            .action-buttons .btn,
            .action-buttons .theme-toggle {
                min-width: auto;
                flex: 1;
                font-size: 0.75rem;
                padding: 0.375rem 0.5rem;
            }
            
            .breadcrumb {
                font-size: 0.8125rem;
            }
            
            .file-name {
                font-size: 0.875rem;
            }
            
            .modal-content {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                padding: 0.75rem;
            }
        }
        
        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            .file-item {
                min-height: 3rem;
                padding: 0.5rem 0.75rem;
            }
            
            .btn, .theme-toggle {
                min-height: 2.75rem;
                min-width: 2.75rem;
            }
            
            .action-btn {
                min-height: 2rem;
                min-width: 2rem;
            }
            
            .file-actions {
                opacity: 1;
            }
            
            .search-box input {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <div class="main-content">
        <!-- Combined Breadcrumb and Toolbar -->
        <div class="breadcrumb-toolbar">
            <!-- First row: Breadcrumb and Search -->
            <div class="toolbar-row">
                <div class="breadcrumb">
                    <a href="<%= url_for('index') %>">
                        <i class="fas fa-home"></i>
                        Home
                    </a>
                    <% breadcrumbs.forEach(crumb => { %>
                        <span class="separator">/</span>
                        <a href="<%= url_for('index', {path: crumb.path}) %>"><%= crumb.name %></a>
                    <% }) %>
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search files..." value="<%= search_query %>">
                    <button type="button" id="clearSearchBtn" class="search-clear-btn" style="display: <%= search_query ? 'block' : 'none' %>;" title="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Second row: Action buttons and Sort -->
            <div class="toolbar-row">
                <div class="action-buttons">
                    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <button class="btn btn-success" id="uploadBtn">
                        <i class="fas fa-upload"></i>
                        Upload
                    </button>
                    
                    <% if (smb_url) { %>
                    <a href="#" class="btn btn-info" onclick="openSmbShare(); return false;" style="flex-wrap:wrap; justify-content:center; text-align:center; line-height:1.2;">
                        <span style="width:100%; display:flex; align-items:center; justify-content:center; gap:0.375rem;"><i class="fas fa-folder-open"></i> Open in File Browser</span>
                        <% if (smb_button_text) { %><small style="width:100%; display:block;"><%= smb_button_text %></small><% } %>
                    </a>
                    <% } %>
                    <% if (is_admin) { %>
                        <button class="btn btn-success" id="createFolderBtn">
                            <i class="fas fa-folder-plus"></i>
                            New Folder
                        </button>
                        
                        <button class="btn btn-secondary" id="undoBtn">
                            <i class="fas fa-undo"></i>
                            Undo
                        </button>
                        
                        <a href="<%= url_for('logout') %>" class="btn btn-secondary">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    <% } else { %>
                        <a href="<%= url_for('login') %>" class="btn">
                            <i class="fas fa-sign-in-alt"></i>
                            Admin Login
                        </a>
                    <% } %>
                </div>
                
                <div class="sort-controls">
                    <label>Sort by:</label>
                    <select id="sortSelect">
                        <option value="name" <% if (sort_by === 'name') { %>selected<% } %>>Name</option>
                        <option value="size" <% if (sort_by === 'size') { %>selected<% } %>>Size</option>
                        <option value="modified" <% if (sort_by === 'modified') { %>selected<% } %>>Modified</option>
                    </select>
                    
                    <button class="btn btn-secondary" id="sortOrderBtn" data-order="<%= order %>">
                        <i class="fas fa-sort-<%= order === 'asc' ? 'up' : 'down' %>"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alertContainer"></div>

        <!-- Hidden File Input -->
        <input type="file" id="fileInput" multiple style="display: none;">
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Uploading...</div>
        </div>

        <!-- File List -->
        <div class="file-list">
            <% if (!items || items.length === 0) { %>
                <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>This directory is empty</p>
                </div>
            <% } %>
            
            <% items.forEach(item => { %>
            <div class="file-item" data-path="<%= item.path %>" data-is-dir="<%= item.is_dir.toString().toLowerCase() %>">
                <div class="file-icon <%= item.is_dir ? 'folder' : 'file' %>">
                    <i class="<%= item.icon %>"></i>
                </div>
                
                <div class="file-info">
                    <div class="file-name"><%= item.name %></div>
                </div>
                
                <div class="file-size"><%= item.size_formatted %></div>
                <div class="file-date"><%= item.modified %></div>
                
                <div class="file-actions">
                    <% if (item.is_dir) { %>
                        <button class="action-btn" title="Download as ZIP" onclick="downloadFolder('<%= item.path %>')">
                            <i class="fas fa-download"></i>
                        </button>
                    <% } else { %>
                        <button class="action-btn" title="Preview" onclick="previewFile('<%= item.path %>')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" title="Download" onclick="downloadFile('<%= item.path %>')">
                            <i class="fas fa-download"></i>
                        </button>
                    <% } %>
                    
                    <% if (is_admin) { %>
                        <button class="action-btn" title="Rename" onclick="renameItem('<%= item.path %>', '<%= item.name %>')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" title="Delete" onclick="deleteItem('<%= item.path %>')">
                            <i class="fas fa-trash"></i>
                        </button>
                    <% } %>
                </div>
            </div>
            <% }) %>
        </div>

        <!-- Shared Text Area -->
        <div class="shared-text-area">
            <div class="shared-text-header">
                <h3>
                    <i class="fas fa-comments"></i>
                    Clipboard
                </h3>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    
                    <button class="btn btn-secondary" id="copyTextBtn" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                        Copy
                    </button>
                </div>
            </div>
            
            <textarea class="shared-text-content" id="sharedTextArea"></textarea>
            
            <div class="text-formatting">
                <button class="format-btn" onclick="formatText('upper')">UPPER</button>
                <button class="format-btn" onclick="formatText('lower')">lower</button>
                <button class="format-btn" onclick="formatText('title')">Title Case</button>
                <button class="format-btn" onclick="formatText('clear')">Clear</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextPreview()">
            <i class="fas fa-eye"></i>
            Preview
        </div>
        <div class="context-menu-item" onclick="contextDownload()">
            <i class="fas fa-download"></i>
            Download
        </div>
        <% if (is_admin) { %>
        <div class="context-menu-item" onclick="contextRename()">
            <i class="fas fa-edit"></i>
            Rename
        </div>
        <div class="context-menu-item danger" onclick="contextDelete()">
            <i class="fas fa-trash"></i>
            Delete
        </div>
        <% } %>
    </div>

    <!-- Download Queue -->
    <div class="download-queue" id="downloadQueue">
        <div class="queue-header">
            <h4>Download Queue</h4>
            <button class="close-btn" onclick="hideDownloadQueue()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="queueItems"></div>
    </div>

    <!-- Modals -->
    
    <!-- Create Folder Modal -->
    <div class="modal" id="createFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Folder</div>
                <button class="close-btn" onclick="closeModal('createFolderModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="createFolderForm">
                <div class="form-group">
                    <label class="form-label">Folder Name</label>
                    <input type="text" class="form-control" id="folderNameInput" placeholder="Enter folder name" required>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createFolderModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Rename Item</div>
                <button class="close-btn" onclick="closeModal('renameModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="renameForm">
                <div class="form-group">
                    <label class="form-label">New Name</label>
                    <input type="text" class="form-control" id="renameInput" required>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('renameModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Rename</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal" id="previewModal">
        <div class="modal-content" style="width: 80vw; height: 80vh; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header" style="flex-shrink: 0;">
                <div class="modal-title" id="previewTitle">File Preview</div>
                <button class="close-btn" onclick="closeModal('previewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="previewContent" style="flex: 1 1 0; min-height: 0; overflow: auto;">
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p>Loading preview...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openSmbShare() {
            const smbUrl = '<%= smb_url %>';
            const isWindows = navigator.platform.indexOf('Win') > -1;
            if (isWindows) {
                const uncPath = smbUrl.replace(/^smb:\/\//, '\\\\').replace(/\//g, '\\');
                const ta = document.createElement('textarea');
                ta.value = uncPath;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                prompt('Path copied to clipboard! Press Win+R and paste to open:', uncPath);
            } else {
                window.open(smbUrl, '_blank');
            }
        }

        // Global variables
        let socket;
        let currentPath = '<%= current_path %>';
        const isAdmin = <%= is_admin ? 'true' : 'false' %>;
        let contextMenuItem = null;
        let downloadQueue = [];
        let sharedTextTimeout = null;
        
        // Initialize Socket.IO
        document.addEventListener('DOMContentLoaded', function() {
            socket = io();
            
            socket.on('connect', function() {
                // Connected to server
            });
            
            socket.on('file_updated', function(data) {
                if (data.path === currentPath) {
                    refreshFileList();
                }
            });
            
            socket.on('shared_text_updated', function(data) {
                const textarea = document.getElementById('sharedTextArea');
                if (document.activeElement !== textarea) {
                    textarea.value = data.content;
                }
            });
            
            initializeTheme();
            initializeFileHandling();
            initializeSharedText();
            initializeSearch();
            initializeSorting();
        });
        
        // Theme handling
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            setTheme(theme);
            
            themeToggle.addEventListener('click', toggleTheme);
            
            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.querySelector('#themeToggle i');
            icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', theme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        // Refresh file list in-place via API
        function refreshFileList() {
            fetch(`/api/files?path=${encodeURIComponent(currentPath)}`)
                .then(r => r.json())
                .then(data => {
                    if (!data.success) return;
                    const items = data.files;

                    // Sort client-side to match current sort state
                    const sortSelect = document.getElementById('sortSelect');
                    const sortOrderBtn = document.getElementById('sortOrderBtn');
                    const sortBy = sortSelect ? sortSelect.value : 'name';
                    const order = sortOrderBtn ? sortOrderBtn.dataset.order : 'asc';
                    const reverse = order === 'desc';

                    items.sort((a, b) => {
                        if (a.is_dir !== b.is_dir) return a.is_dir ? -1 : 1;
                        let cmp = 0;
                        if (sortBy === 'size') cmp = a.size - b.size;
                        else if (sortBy === 'modified') cmp = new Date(a.modified) - new Date(b.modified);
                        else cmp = a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                        return reverse ? -cmp : cmp;
                    });

                    const fileList = document.querySelector('.file-list');
                    if (!fileList) return;

                    if (items.length === 0) {
                        fileList.innerHTML = `
                            <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                                <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>This directory is empty</p>
                            </div>`;
                        return;
                    }

                    fileList.innerHTML = items.map(item => {
                        const ePath = escapeHtml(item.path);
                        const eName = escapeHtml(item.name);
                        const jsPath = item.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                        const jsName = item.name.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                        return `
                        <div class="file-item" data-path="${ePath}" data-is-dir="${item.is_dir}">
                            <div class="file-icon ${item.is_dir ? 'folder' : 'file'}">
                                <i class="${escapeHtml(item.icon)}"></i>
                            </div>
                            <div class="file-info">
                                <div class="file-name">${eName}</div>
                            </div>
                            <div class="file-size">${escapeHtml(item.size_formatted)}</div>
                            <div class="file-date">${escapeHtml(item.modified)}</div>
                            <div class="file-actions">
                                ${item.is_dir ? `
                                    <button class="action-btn" title="Download as ZIP" onclick="downloadFolder('${jsPath}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                ` : `
                                    <button class="action-btn" title="Preview" onclick="previewFile('${jsPath}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn" title="Download" onclick="downloadFile('${jsPath}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                `}
                                ${isAdmin ? `
                                    <button class="action-btn" title="Rename" onclick="renameItem('${jsPath}', '${jsName}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn" title="Delete" onclick="deleteItem('${jsPath}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>`;
                    }).join('');

                    // Re-attach click/context handlers for new file items
                    document.querySelectorAll('.file-item').forEach(item => {
                        item.addEventListener('click', handleFileClick);
                        item.addEventListener('contextmenu', handleContextMenu);
                    });
                })
                .catch(err => console.error('Failed to refresh file list:', err));
        }

        // File handling
        function initializeFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            
            // Upload button click handler
            if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', () => fileInput.click());
            }
            
            // Whole page drag and drop
            document.addEventListener('dragover', handlePageDragOver);
            document.addEventListener('dragleave', handlePageDragLeave);
            document.addEventListener('drop', handlePageDrop);
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            // File item click handlers
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', handleFileClick);
                item.addEventListener('contextmenu', handleContextMenu);
            });
            
            // Modal handlers
            const createFolderBtn = document.getElementById('createFolderBtn');
            if (createFolderBtn) {
                createFolderBtn.addEventListener('click', () => showModal('createFolderModal'));
            }
            
            const undoBtn = document.getElementById('undoBtn');
            if (undoBtn) {
                undoBtn.addEventListener('click', undoLastAction);
            }
            
            // Form handlers
            const createFolderForm = document.getElementById('createFolderForm');
            if (createFolderForm) {
                createFolderForm.addEventListener('submit', handleCreateFolder);
            }
            
            const renameForm = document.getElementById('renameForm');
            if (renameForm) {
                renameForm.addEventListener('submit', handleRename);
            }
            
            // Hide context menu on click outside
            document.addEventListener('click', hideContextMenu);
        }
        
        function handlePageDragOver(e) {
            e.preventDefault();
            
            // Don't show upload overlay if dragging in modal
            if (e.target.closest('.modal.show')) {
                return;
            }
            
            document.body.classList.add('dragover');
        }
        
        function handlePageDragLeave(e) {
            e.preventDefault();
            // Only remove dragover class if we're leaving the document body
            if (!e.relatedTarget || e.relatedTarget.nodeName === 'HTML') {
                document.body.classList.remove('dragover');
            }
        }
        
        function handlePageDrop(e) {
            e.preventDefault();
            document.body.classList.remove('dragover');
            
            // Don't handle file upload if dropping in modal
            if (e.target.closest('.modal.show')) {
                return;
            }
            
            if (e.dataTransfer.files.length > 0) {
                const files = Array.from(e.dataTransfer.files);
                uploadFiles(files);
            }
        }
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadFiles(files);
        }
        
        function uploadFiles(files) {
            if (files.length === 0) return;
            
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            formData.append('path', currentPath);
            
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Uploading...';
            
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    progressText.textContent = `Uploading... ${Math.round(percentComplete)}%`;
                }
            });
            
            xhr.addEventListener('load', () => {
                progressContainer.style.display = 'none';
                
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    showAlert('Files uploaded successfully!', 'success');
                    // File list will be updated via socket
                } else {
                    const error = JSON.parse(xhr.responseText);
                    showAlert(error.error || 'Upload failed', 'error');
                }
            });
            
            xhr.addEventListener('error', () => {
                progressContainer.style.display = 'none';
                showAlert('Upload failed', 'error');
            });
            
            xhr.open('POST', '/upload');
            xhr.send(formData);
        }
        
        function handleFileClick(e) {
            if (e.target.closest('.file-actions')) return;
            
            const item = e.currentTarget;
            const path = item.dataset.path;
            const isDir = item.dataset.isDir === 'true';
            
            if (isDir) {
                window.location.href = `/?path=${encodeURIComponent(path)}`;
            }
        }
        
        function handleContextMenu(e) {
            e.preventDefault();
            
            const item = e.currentTarget;
            const path = item.dataset.path;
            const isDir = item.dataset.isDir === 'true';
            
            contextMenuItem = { path, isDir };
            
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
        }
        
        function hideContextMenu() {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.style.display = 'none';
        }
        
        function contextPreview() {
            if (contextMenuItem) {
                previewFile(contextMenuItem.path);
            }
            hideContextMenu();
        }
        
        function contextDownload() {
            if (contextMenuItem) {
                if (contextMenuItem.isDir) {
                    downloadFolder(contextMenuItem.path);
                } else {
                    downloadFile(contextMenuItem.path);
                }
            }
            hideContextMenu();
        }
        
        function contextRename() {
            if (contextMenuItem) {
                const fileName = contextMenuItem.path.split('/').pop();
                renameItem(contextMenuItem.path, fileName);
            }
            hideContextMenu();
        }
        
        function contextDelete() {
            if (contextMenuItem) {
                deleteItem(contextMenuItem.path);
            }
            hideContextMenu();
        }
        
        // File operations
        function downloadFile(path) {
            addToDownloadQueue(path, 'file');
            window.open(`/download?path=${encodeURIComponent(path)}`, '_blank');
        }
        
        function downloadFolder(path) {
            addToDownloadQueue(path, 'folder');
            window.open(`/download_folder?path=${encodeURIComponent(path)}`, '_blank');
        }
        
        // Enhanced Preview System with PDF, Code Highlighting, and Markdown
        function previewFile(path) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const content = document.getElementById('previewContent');
            
            const fileName = path.split('/').pop();
            title.textContent = `Preview: ${fileName}`;
            
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="loading-spinner"></div>
                    <p>Loading preview...</p>
                </div>
            `;
            
            showModal('previewModal');
            
            // Check file type and create appropriate preview
            const ext = fileName.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'];
            const videoExts = ['mp4', 'avi', 'mkv', 'mov', 'wmv', 'webm'];
            const audioExts = ['mp3', 'wav', 'flac', 'aac', 'ogg', 'm4a'];
            const codeExts = ['js', 'jsx', 'ts', 'tsx', 'py', 'java', 'c', 'cpp', 'h', 'hpp', 'cs', 'php', 'rb', 'go', 'rs', 'swift', 'kt', 'scala', 'sh', 'bash', 'ps1', 'css', 'scss', 'sass', 'html', 'xml', 'json', 'yaml', 'yml', 'sql', 'dockerfile', 'makefile'];
            const markdownExts = ['md', 'markdown', 'mdown', 'mkd'];
            
            if (ext === 'pdf') {
                // PDF Preview with PDF.js
                previewPDF(path, content, fileName);
            } else if (imageExts.includes(ext)) {
                // Enhanced Image Preview with zoom
                content.innerHTML = `
                    <div style="height: 100%; display: flex; flex-direction: column; align-items: center;">
                        <img id="previewImage" src="/download?path=${encodeURIComponent(path)}"
                             style="max-width: 100%; flex: 1 1 0; min-height: 0; object-fit: contain; border-radius: 0.375rem; cursor: zoom-in; transition: transform 0.3s;"
                             alt="${fileName}"
                             onclick="toggleImageZoom(this)"
                             draggable="false"
                             ondragstart="return false;">
                        <div style="flex-shrink: 0; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Click image to zoom  Right-click to download
                        </div>
                    </div>
                `;
            } else if (videoExts.includes(ext)) {
                // Enhanced Video Preview
                content.innerHTML = `
                    <div style="height: 100%; display: flex; flex-direction: column; align-items: center;">
                        <video controls style="max-width: 100%; flex: 1 1 0; min-height: 0; object-fit: contain; border-radius: 0.375rem;" preload="metadata">
                            <source src="/download?path=${encodeURIComponent(path)}">
                            Your browser does not support the video tag.
                        </video>
                        <div style="flex-shrink: 0; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                            ${fileName}  Video Preview
                        </div>
                    </div>
                `;
            } else if (audioExts.includes(ext)) {
                // Enhanced Audio Preview
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="background: linear-gradient(135deg, var(--accent-color), #6f42c1); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                            <i class="fas fa-music" style="font-size: 3rem; color: white;"></i>
                        </div>
                        <h3 style="margin-bottom: 1rem; word-break: break-word;">${fileName}</h3>
                        <audio controls style="width: 100%; max-width: 400px; margin-top: 1rem;" preload="metadata">
                            <source src="/download?path=${encodeURIComponent(path)}">
                            Your browser does not support the audio tag.
                        </audio>
                        <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Audio File Preview
                        </div>
                    </div>
                `;
            } else if (markdownExts.includes(ext)) {
                // Markdown Preview with rendering
                previewMarkdown(path, content, fileName);
            } else if (codeExts.includes(ext)) {
                // Code Preview with syntax highlighting
                previewCode(path, content, fileName, ext);
            } else {
                // Try to preview as plain text
                fetch(`/preview?path=${encodeURIComponent(path)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            content.innerHTML = `
                                <div style="height: 100%; display: flex; flex-direction: column;">
                                    <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.375rem; overflow: auto; flex: 1 1 0; min-height: 0; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.5; white-space: pre-wrap; border: 1px solid var(--border-color);">
                                        ${escapeHtml(data.content)}
                                    </div>
                                    <div style="flex-shrink: 0; margin-top: 0.5rem; text-align: center; font-size: 0.875rem; color: var(--text-secondary);">
                                        ${fileName}  Plain Text Preview
                                    </div>
                                </div>
                            `;
                        } else {
                            showPreviewNotAvailable(content, path, fileName);
                        }
                    })
                    .catch(error => {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 2rem;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 4rem; margin-bottom: 1rem; color: var(--warning-color);"></i>
                                <p>Error loading preview</p>
                                <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                                    ${error.message}
                                </div>
                            </div>
                        `;
                    });
            }
        }
        
        // PDF Preview Function
        function previewPDF(path, content, fileName) {
            content.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column; align-items: center;">
                    <div style="flex-shrink: 0; margin-bottom: 0.5rem;">
                        <button class="btn btn-secondary" onclick="downloadFile('${path}')">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    <div id="pdfContainer" style="flex: 1 1 0; min-height: 0; width: 100%; border: 1px solid var(--border-color); border-radius: 0.375rem; overflow: auto; background: #f5f5f5;">
                        <div style="padding: 2rem;">
                            <div class="loading-spinner"></div>
                            <p>Loading PDF...</p>
                        </div>
                    </div>
                    <div style="flex-shrink: 0; margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-secondary);">
                        ${fileName}  PDF Preview
                    </div>
                </div>
            `;
            
            // Load PDF with PDF.js
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.getDocument(`/download?path=${encodeURIComponent(path)}`).promise.then(pdf => {
                    const container = document.getElementById('pdfContainer');
                    container.innerHTML = '';
                    
                    // Render first few pages
                    const maxPages = Math.min(pdf.numPages, 5);
                    for (let pageNum = 1; pageNum <= maxPages; pageNum++) {
                        pdf.getPage(pageNum).then(page => {
                            // Calculate scale to fit container width
                            const containerWidth = container.offsetWidth - 40; // Account for padding
                            const viewport = page.getViewport({ scale: 1.0 });
                            const scale = Math.min(containerWidth / viewport.width, 2.0); // Max scale 2.0
                            const scaledViewport = page.getViewport({ scale });
                            
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = scaledViewport.height;
                            canvas.width = scaledViewport.width;
                            canvas.style.width = '100%';
                            canvas.style.height = 'auto';
                            canvas.style.marginBottom = '1rem';
                            canvas.style.maxWidth = '100%';
                            
                            page.render({ canvasContext: context, viewport: scaledViewport }).promise.then(() => {
                                container.appendChild(canvas);
                                if (pageNum === maxPages && pdf.numPages > maxPages) {
                                    const morePages = document.createElement('div');
                                    morePages.innerHTML = `
                                        <div style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                                            ... and ${pdf.numPages - maxPages} more pages<br>
                                            <small>Download PDF to view all pages</small>
                                        </div>
                                    `;
                                    container.appendChild(morePages);
                                }
                            });
                        });
                    }
                }).catch(error => {
                    document.getElementById('pdfContainer').innerHTML = `
                        <div style="padding: 2rem; text-align: center;">
                            <i class="fas fa-file-pdf" style="font-size: 4rem; margin-bottom: 1rem; color: var(--danger-color);"></i>
                            <p>Unable to preview PDF</p>
                            <small style="color: var(--text-secondary);">${error.message}</small>
                        </div>
                    `;
                });
            } else {
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="padding: 2rem; text-align: center;">
                        <i class="fas fa-file-pdf" style="font-size: 4rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
                        <p>PDF preview not available</p>
                        <small>PDF.js library not loaded</small>
                    </div>
                `;
            }
        }
        
        // Code Preview with Syntax Highlighting
        function previewCode(path, content, fileName, ext) {
            fetch(`/preview?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const codeContent = data.content;
                        const codeId = 'code-' + Date.now();
                        
                        content.innerHTML = `
                            <div style="height: 100%; display: flex; flex-direction: column;">
                                <div style="flex: 1 1 0; min-height: 0; display: flex; flex-direction: column; background: var(--bg-secondary); border-radius: 0.375rem; overflow: hidden; border: 1px solid var(--border-color);">
                                    <div style="flex-shrink: 0; padding: 0.75rem 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: between;">
                                        <span style="font-weight: 500; font-size: 0.875rem;">${fileName}</span>
                                        <span style="margin-left: auto; font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase;">${ext}</span>
                                    </div>
                                    <pre style="flex: 1 1 0; min-height: 0; overflow: auto; margin: 0;"><code id="${codeId}" class="language-${ext}" style="display: block; padding: 1rem; margin: 0; font-size: 0.875rem; line-height: 1.5;">${escapeHtml(codeContent)}</code></pre>
                                </div>
                                <div style="flex-shrink: 0; margin-top: 0.5rem; text-align: center; font-size: 0.875rem; color: var(--text-secondary);">
                                    Code Preview with Syntax Highlighting
                                </div>
                            </div>
                        `;
                        
                        // Apply syntax highlighting if available
                        if (typeof hljs !== 'undefined') {
                            setTimeout(() => {
                                const codeBlock = document.getElementById(codeId);
                                hljs.highlightElement(codeBlock);
                            }, 100);
                        }
                    } else {
                        showPreviewNotAvailable(content, path, fileName);
                    }
                })
                .catch(error => {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-code" style="font-size: 4rem; margin-bottom: 1rem; color: var(--warning-color);"></i>
                            <p>Error loading code preview</p>
                            <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                                ${error.message}
                            </div>
                        </div>
                    `;
                });
        }
        
        // Markdown Preview with Rendering
        function previewMarkdown(path, content, fileName) {
            fetch(`/preview?path=${encodeURIComponent(path)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const markdownContent = data.content;
                        
                        content.innerHTML = `
                            <div style="height: 100%; display: flex; flex-direction: column;">
                                <div style="flex-shrink: 0; display: flex; gap: 0.5rem; margin-bottom: 0.5rem; justify-content: center;">
                                    <button class="btn btn-secondary" id="mdRaw" onclick="toggleMarkdownView('raw')">
                                        <i class="fas fa-code"></i> Raw
                                    </button>
                                    <button class="btn" id="mdRendered" onclick="toggleMarkdownView('rendered')">
                                        <i class="fas fa-eye"></i> Rendered
                                    </button>
                                </div>

                                <div id="markdownRaw" style="display: none; flex: 1 1 0; min-height: 0; overflow: auto;">
                                    <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.375rem; font-family: 'Courier New', monospace; font-size: 0.875rem; line-height: 1.5; white-space: pre-wrap; border: 1px solid var(--border-color);">${escapeHtml(markdownContent)}</pre>
                                </div>

                                <div id="markdownRendered" style="flex: 1 1 0; min-height: 0; background: var(--bg-primary); padding: 1.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color); overflow: auto;">
                                    <div class="loading-spinner" style="text-align: center;"></div>
                                    <p style="text-align: center;">Rendering markdown...</p>
                                </div>

                                <div style="flex-shrink: 0; margin-top: 0.5rem; text-align: center; font-size: 0.875rem; color: var(--text-secondary);">
                                    ${fileName}  Markdown Preview
                                </div>
                            </div>
                        `;
                        
                        // Render markdown if library is available
                        if (typeof marked !== 'undefined') {
                            setTimeout(() => {
                                const renderedDiv = document.getElementById('markdownRendered');
                                try {
                                    const html = marked.parse(markdownContent);
                                    renderedDiv.innerHTML = html;
                                    renderedDiv.style.lineHeight = '1.6';
                                } catch (error) {
                                    renderedDiv.innerHTML = `
                                        <div style="text-align: center; padding: 2rem;">
                                            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-bottom: 1rem;"></i>
                                            <p>Error rendering markdown</p>
                                            <small>${error.message}</small>
                                        </div>
                                    `;
                                }
                            }, 100);
                        } else {
                            document.getElementById('markdownRendered').innerHTML = `
                                <div style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-markdown" style="font-size: 4rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
                                    <p>Markdown rendering not available</p>
                                    <small>Marked.js library not loaded</small>
                                </div>
                            `;
                        }
                    } else {
                        showPreviewNotAvailable(content, path, fileName);
                    }
                })
                .catch(error => {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-markdown" style="font-size: 4rem; margin-bottom: 1rem; color: var(--warning-color);"></i>
                            <p>Error loading markdown</p>
                            <div style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                                ${error.message}
                            </div>
                        </div>
                    `;
                });
        }
        
        // Helper Functions
        function showPreviewNotAvailable(content, path, fileName) {
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-file" style="font-size: 4rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
                    <h3 style="margin-bottom: 1rem;">${fileName}</h3>
                    <p>Preview not available for this file type</p>
                    <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn" onclick="downloadFile('${path}')">
                            <i class="fas fa-download"></i>
                            Download File
                        </button>
                    </div>
                </div>
            `;
        }
        
        function toggleImageZoom(img) {
            if (img.style.transform === 'scale(2)') {
                img.style.transform = 'scale(1)';
                img.style.cursor = 'zoom-in';
                img.style.maxHeight = '70vh';
            } else {
                img.style.transform = 'scale(2)';
                img.style.cursor = 'zoom-out';
                img.style.maxHeight = 'none';
            }
        }
        
        function toggleMarkdownView(view) {
            const rawDiv = document.getElementById('markdownRaw');
            const renderedDiv = document.getElementById('markdownRendered');
            const rawBtn = document.getElementById('mdRaw');
            const renderedBtn = document.getElementById('mdRendered');
            
            if (view === 'raw') {
                rawDiv.style.display = 'block';
                renderedDiv.style.display = 'none';
                rawBtn.className = 'btn';
                renderedBtn.className = 'btn btn-secondary';
            } else {
                rawDiv.style.display = 'none';
                renderedDiv.style.display = 'block';
                rawBtn.className = 'btn btn-secondary';
                renderedBtn.className = 'btn';
            }
        }
        
        function renameItem(path, currentName) {
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('renameInput');
            
            input.value = currentName;
            input.dataset.path = path;
            
            showModal('renameModal');
            setTimeout(() => input.focus(), 100);
        }
        
        function deleteItem(path) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            fetch('/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ path })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Item deleted successfully', 'success');
                    // Reload the page to update the file list
                    setTimeout(() => location.reload(), 500);
                } else {
                    showAlert(data.error || 'Delete failed', 'error');
                }
            })
            .catch(error => {
                showAlert('Delete failed', 'error');
            });
        }
        
        function handleCreateFolder(e) {
            e.preventDefault();
            
            const folderName = document.getElementById('folderNameInput').value.trim();
            if (!folderName) return;
            
            fetch('/create_folder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: currentPath,
                    name: folderName 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Folder created successfully', 'success');
                    closeModal('createFolderModal');
                    document.getElementById('folderNameInput').value = '';
                } else {
                    showAlert(data.error || 'Failed to create folder', 'error');
                }
            })
            .catch(error => {
                showAlert('Failed to create folder', 'error');
            });
        }
        
        function handleRename(e) {
            e.preventDefault();
            
            const input = document.getElementById('renameInput');
            const newName = input.value.trim();
            const path = input.dataset.path;
            
            if (!newName) return;
            
            fetch('/rename', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    path: path,
                    name: newName 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Item renamed successfully', 'success');
                    closeModal('renameModal');
                } else {
                    showAlert(data.error || 'Failed to rename item', 'error');
                }
            })
            .catch(error => {
                showAlert('Failed to rename item', 'error');
            });
        }
        
        function undoLastAction() {
            if (!confirm('Undo the last action?')) return;
            
            fetch('/undo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Action undone successfully', 'success');
                } else {
                    showAlert(data.error || 'Failed to undo action', 'error');
                }
            })
            .catch(error => {
                showAlert('Failed to undo action', 'error');
            });
        }
        
        // Download queue
        function addToDownloadQueue(path, type) {
            const fileName = path.split('/').pop() || 'files';
            const item = {
                id: Date.now(),
                path: path,
                name: fileName,
                type: type,
                status: 'downloading'
            };
            
            downloadQueue.push(item);
            updateDownloadQueue();
            showDownloadQueue();
            
            // Simulate download completion
            setTimeout(() => {
                item.status = 'completed';
                updateDownloadQueue();
                
                setTimeout(() => {
                    removeFromDownloadQueue(item.id);
                }, 3000);
            }, 2000);
        }
        
        function removeFromDownloadQueue(id) {
            downloadQueue = downloadQueue.filter(item => item.id !== id);
            updateDownloadQueue();
            
            if (downloadQueue.length === 0) {
                hideDownloadQueue();
            }
        }
        
        function updateDownloadQueue() {
            const queueItems = document.getElementById('queueItems');
            
            queueItems.innerHTML = downloadQueue.map(item => `
                <div class="queue-item">
                    <div>
                        <i class="fas fa-${item.type === 'folder' ? 'folder' : 'file'}"></i>
                        ${item.name}
                    </div>
                    <div>
                        ${item.status === 'downloading' ? 
                            '<div class="loading-spinner"></div>' : 
                            '<i class="fas fa-check" style="color: var(--success-color);"></i>'
                        }
                    </div>
                </div>
            `).join('');
        }
        
        function showDownloadQueue() {
            document.getElementById('downloadQueue').classList.add('show');
        }
        
        function hideDownloadQueue() {
            document.getElementById('downloadQueue').classList.remove('show');
        }
        
        // Shared text area
        function initializeSharedText() {
            const textarea = document.getElementById('sharedTextArea');
            const copyBtn = document.getElementById('copyTextBtn');
            
            // Load initial content
            fetch('/shared_text')
                .then(response => response.json())
                .then(data => {
                    textarea.value = data.content;
                })
                .catch(error => {
                    console.error('Failed to load shared text:', error);
                });
            
            // Handle text changes
            textarea.addEventListener('input', () => {
                clearTimeout(sharedTextTimeout);
                sharedTextTimeout = setTimeout(() => {
                    updateSharedText(textarea.value);
                }, 500);
            });
            
            // Handle copy button
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    copyToClipboard(textarea.value);
                });
            }
        }
        
        function updateSharedText(content) {
            fetch('/shared_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content })
            })
            .catch(error => {
                console.error('Failed to update shared text:', error);
            });
        }
        
        function formatText(type) {
            const textarea = document.getElementById('sharedTextArea');
            let content = textarea.value;
            
            switch (type) {
                case 'upper':
                    content = content.toUpperCase();
                    break;
                case 'lower':
                    content = content.toLowerCase();
                    break;
                case 'title':
                    content = content.replace(/\w\S*/g, (txt) => 
                        txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
                    );
                    break;
                case 'clear':
                    content = '';
                    break;
            }
            
            textarea.value = content;
            // Immediately update shared text to sync with other clients
            updateSharedText(content);
            textarea.focus();
        }
        
        // Search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('clearSearchBtn');
            let searchTimeout;
            
            // Store all file items for filtering
            const allFileItems = Array.from(document.querySelectorAll('.file-item'));
            
            // Function to filter items client-side
            function filterItems(query) {
                const lowerQuery = query.toLowerCase();
                let visibleCount = 0;
                
                allFileItems.forEach(item => {
                    const fileName = item.querySelector('.file-name').textContent.toLowerCase();
                    const matches = !query || fileName.includes(lowerQuery);
                    item.style.display = matches ? 'grid' : 'none';
                    if (matches) visibleCount++;
                });
                
                // Show/hide no results message
                let noResultsDiv = document.getElementById('noSearchResults');
                if (query && visibleCount === 0) {
                    if (!noResultsDiv) {
                        noResultsDiv = document.createElement('div');
                        noResultsDiv.id = 'noSearchResults';
                        noResultsDiv.innerHTML = `
                            <div style="padding: 3rem; text-align: center; color: var(--text-secondary);">
                                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <p>No files found matching "<strong>${query}</strong>"</p>
                            </div>
                        `;
                        document.querySelector('.file-list').appendChild(noResultsDiv);
                    }
                } else if (noResultsDiv) {
                    noResultsDiv.remove();
                }
                
                // Update URL without refresh for bookmarking
                const url = new URL(window.location);
                if (query) {
                    url.searchParams.set('search', query);
                } else {
                    url.searchParams.delete('search');
                }
                history.replaceState({}, '', url.toString());
            }
            
            searchInput.addEventListener('input', () => {
                const query = searchInput.value.trim();
                
                // Show/hide clear button based on input content
                clearBtn.style.display = searchInput.value ? 'flex' : 'none';
                
                // Clear timeout and filter immediately for better mobile experience
                clearTimeout(searchTimeout);
                
                // Use shorter timeout for responsive feel
                searchTimeout = setTimeout(() => {
                    filterItems(query);
                }, 150);
            });
            
            // Clear button functionality
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    clearBtn.style.display = 'none';
                    filterItems(''); // Clear search immediately
                    searchInput.focus(); // Keep focus on mobile
                });
            }
            
            // Initialize search on page load if there's a search query
            const urlParams = new URLSearchParams(window.location.search);
            const initialSearch = urlParams.get('search');
            if (initialSearch && initialSearch !== searchInput.value) {
                searchInput.value = initialSearch;
                clearBtn.style.display = 'flex';
                filterItems(initialSearch);
            }
        }
        
        // Sorting functionality
        function initializeSorting() {
            const sortSelect = document.getElementById('sortSelect');
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    updateSort();
                });
            }
            
            if (sortOrderBtn) {
                sortOrderBtn.addEventListener('click', () => {
                    const currentOrder = sortOrderBtn.dataset.order;
                    const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                    sortOrderBtn.dataset.order = newOrder;
                    
                    const icon = sortOrderBtn.querySelector('i');
                    icon.className = `fas fa-sort-${newOrder === 'asc' ? 'up' : 'down'}`;
                    
                    updateSort();
                });
            }
        }
        
        function updateSort() {
            const sortSelect = document.getElementById('sortSelect');
            const sortOrderBtn = document.getElementById('sortOrderBtn');
            
            const url = new URL(window.location);
            url.searchParams.set('sort', sortSelect.value);
            url.searchParams.set('order', sortOrderBtn.dataset.order);
            
            window.location.href = url.toString();
        }
        
        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            
            // Stop any audio/video that might be playing in the modal
            if (modalId === 'previewModal') {
                const audioElements = modal.querySelectorAll('audio');
                const videoElements = modal.querySelectorAll('video');
                
                audioElements.forEach(audio => {
                    audio.pause();
                    audio.currentTime = 0;
                });
                
                videoElements.forEach(video => {
                    video.pause();
                    video.currentTime = 0;
                });
            }
            
            modal.classList.remove('show');
        }
        
        // Alert functions
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${type}" id="${alertId}">
                    <i class="fas fa-${getAlertIcon(type)}"></i>
                    ${message}
                    <button class="close-btn" onclick="closeAlert('${alertId}')" style="margin-left: auto;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                closeAlert(alertId);
            }, 5000);
        }
        
        function getAlertIcon(type) {
            switch (type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-triangle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }
        
        function closeAlert(alertId) {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.opacity = '0';
                alert.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    alert.remove();
                }, 300);
            }
        }
        
        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function copyToClipboard(text) {
            // Check if modern clipboard API is available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showAlert('Text copied to clipboard!', 'success');
                }).catch(err => {
                    // Fallback if modern API fails
                    copyToClipboardFallback(text);
                });
            } else {
                // Use fallback method
                copyToClipboardFallback(text);
            }
        }
        
        function copyToClipboardFallback(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.left = '-999999px';
            textarea.style.top = '-999999px';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showAlert('Text copied to clipboard!', 'success');
                } else {
                    showAlert('Failed to copy text', 'error');
                }
            } catch (err) {
                showAlert('Copy not supported in this browser', 'error');
            }
            
            document.body.removeChild(textarea);
        }
        
        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                const modalId = e.target.id;
                closeModal(modalId);
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape key closes modals and context menu
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    closeModal(modal.id);
                });
                hideContextMenu();
            }
            
            // Ctrl+U for upload (admin only)
            if (e.ctrlKey && e.key === 'u' && document.getElementById('fileInput')) {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
            
            // Ctrl+N for new folder (admin only)
            if (e.ctrlKey && e.key === 'n' && document.getElementById('createFolderBtn')) {
                e.preventDefault();
                showModal('createFolderModal');
            }
        });
    </script>
</body>
</html>